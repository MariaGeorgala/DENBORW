import os
from openai import OpenAI

client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

# ---------------------------------------------------------
# ADAPTIVE ΕΡΩΤΗΣΗ (βάσει προηγούμενων απαντήσεων)
# ---------------------------------------------------------
def generate_adaptive_question(previous_answers, step, emotion_memory=None):

    prompt = f"""
Έστω ότι είσαι ένας ήπιος ψυχολογικός βοηθός.

Προηγούμενες απαντήσεις χρήστη:
{previous_answers}

Βήμα ερώτησης: {step}
Συναισθηματικό ιστορικό προηγούμενων ημερών:
{emotion_memory}

Δημιούργησε ΜΙΑ σύντομη ερώτηση που:
- δεν επαναλαμβάνει κάποια από τις προηγούμενες
- είναι φυσική συνέχεια της συζήτησης
- εμβαθύνει λίγο περισσότερο κάθε φορά
- αλλάζει θεματική (σκέψεις, σώμα, ενέργεια, σχέσεις, γεγονότα)

ΕΠΙΣΤΡΕΨΕ ΜΟΝΟ την ερώτηση.
"""

    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[{"role": "user", "content": prompt}]
    )

    return response.choices[0].message.content.strip()


# ---------------------------------------------------------
# FOLLOW-UP ΕΡΩΤΗΣΗ (πάνω στην τελευταία απάντηση)
# ---------------------------------------------------------
def generate_followup_question(previous_answers):

    last_answer = previous_answers[-1]

    prompt = f"""
Ο χρήστης απάντησε:
"{last_answer}"

Δημιούργησε ΜΙΑ σύντομη follow-up ερώτηση
που ζητά λίγο περισσότερη διευκρίνιση από τον χρήστη.

ΕΠΙΣΤΡΕΨΕ ΜΟΝΟ την ερώτηση.
"""

    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[{"role": "user", "content": prompt}]
    )

    return response.choices[0].message.content.strip()


# ---------------------------------------------------------
# ΑΝΑΛΥΣΗ ΣΥΝΑΙΣΘΗΜΑΤΟΣ
# ---------------------------------------------------------
def analyze_conversation_with_llm(answers):

    prompt = f"""
Είσαι ειδικός σύμβουλος ψυχικής υγείας και αναλυτής συναισθήματος.

Σου δίνονται απαντήσεις χρήστη σε ερωτήσεις σχετικές με τη διάθεσή του.
Στόχος σου είναι:
- να κατανοήσεις το συνολικό συναισθηματικό νόημα των απαντήσεων
- να αγνοήσεις άσχετες ή ουδέτερες πληροφορίες
- να λάβεις υπόψη το ύφος, τις λέξεις και το περιεχόμενο

Οδηγίες:
1. Επίλεξε ΕΝΑ βασικό συναίσθημα που κυριαρχεί (π.χ. χαρά, λύπη, θυμός, άγχος, φόβος, ουδέτερος).
2. Υπολόγισε έναν αριθμό έντασης από 1 έως 10:
   - 1 = πολύ χαμηλή συναισθηματική φόρτιση
   - 10 = πολύ έντονη συναισθηματική φόρτιση
3. Αν υπάρχουν μεικτά συναισθήματα, επίλεξε το πιο έντονο.
4. Μην δώσεις καμία εξήγηση.
5. Μην γράψεις πρόταση.
6. Μην βάλεις σύμβολα ή emojis.

Απαντήσεις χρήστη:
{answers}

Η απάντησή σου ΠΡΕΠΕΙ να είναι αυστηρά στη μορφή:

συναίσθημα - αριθμός

Παράδειγμα:
χαρά - 7
"""
    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[{"role": "user", "content": prompt}]
    )

    return response.choices[0].message.content.strip()
